---
title: "cao miyuan"
author: "cao miyuan"
date: "`r Sys.Date()`"
output: html_document
prettydoc::html_pretty:
theme: cayman
highlight: github
math: katex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
 echo = TRUE,
 message = FALSE,
 warning = FALSE,
 cache = TRUE,
 collapse = TRUE
)
```

## Install R package MantaID

```{R}
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager",repos = "http://cran.us.r-project.org")
if (!requireNamespace("remotes", quietly = TRUE))
    install.packages("remotes",repos = "http://cran.us.r-project.org")
library(remotes)
install_version("mlr3learners","0.5.1",force = T,upgrade ="never")
library(mlr3learners)
install_version("mlr3tuning","0.13.1",force = T,upgrade ="never")
library(mlr3tuning)
install_version("mlr3","0.13.4",force = T,upgrade ="never")
library(BiocManager)
BiocManager::install("biomaRt", version = "3.16",force = TRUE)
library(mlr3learners)
library(mlr3tuning)
library(biomaRt)
install.packages("ggplot2")
install.packages("caret")
install.packages("data.table")
install.packages("dplyr")
install.packages("keras")
install.packages("magrittr")
install.packages("purrr")
install.packages("reshape2")
install.packages("scutr")
install.packages("stringr")
install.packages("tibble")
install.packages("tidyr")
install.packages("tidyselect")
install.packages("paradox")
install.packages("usthis")
library(ggplot2)
library(caret)
library(data.table)
library(dplyr)
library(keras)
library(magrittr)
library(purrr)
library(reshape2)
library(scutr)
library(stringr)
library(tibble)
library(tidyr)
library(tidyselect)
library(paradox)
if (!requireNamespace("devtools", quietly = TRUE))
    install.packages("devtools")
library(usethis)
library(devtools)
install_bitbucket("Molaison/MantaID")
library(MantaID)
```
## choose ""hsapiens_gene_ensembl"", run the following code

### 1.Data Retrieving

```{R}
#Select the Ensemble dataset of eligible human genes in the BioMart database.
attributes = mi_get_ID_attr(biomart = "genes", dataset = "hsapiens_gene_ensembl", mirror = "asia")
#Select the attributes in lines 1, 2, 6, and 7.
flt_attri = attributes %>% dplyr::slice(1,2,6,7)
#Automatically retrieve incoming attributes, and process the results into a long table.
data_ID = mi_get_ID(flt_attri,biomart = "genes", dataset = "hsapiens_gene_ensembl", mirror = "asia")
data_ID
```

## 2.Data Processing
```{R}
#Create a 4x3 tibble data frame.
data <- tibble::tibble(
	"ensembl_gene_id" = c("ENSG00000001626","ENSG00000002549","ENSG00000002586","ENSG00000002745"),
	'ensembl_exon_id' = c("ENSE00002398851","ENSE00002398851","ENSE00002398851","ENSE00002398851"),
	'refseq_peptide' = c("NP_001303256","-","NP_001382772","NP_001340728")
)
#Re-arrange the tibble data box according to the ID and remove the rows with "-" in the ID.
data_ID_clean = mi_clean_data(data,placeholder="-")
```

```{R}
#Get max length of ID data.
pad_len = mi_get_padlen(data_ID)
#Cut the string of ID column character by character and divide it into multiple columns.
data_splt = mi_split_col(data_ID,cores = NULL,pad_len = pad_len)
#View the internal structure of the data.
str(data_splt)
```

```{R}
#Convert data to numeric, and for the ID column convert with fixed levels.
data_fct = mi_to_numer(data_splt,levels = c("*", 0:9, letters, LETTERS, "_", ".", "-", " ", "/", "\\", ":"))
```

## 3.Data Balancing

```{R}
#Balance data.
data_blcd = mi_balance_data(data_fct,ratio = 0.3,parallel = F)
```

# 4.Models Training

```{R}
#Repeatedly sampling 4000 rows of data, benchmarking for different learners, evaluating the training and test sets separately after training, and outputting a list of benchmarking results and scores for the test set.
result <- mi_run_bmr(data_fct, row_num = 4000)
#The first column of the list shows the benchmark results for the test set.
benchmark <- result[1]
#The second column of the list is a list of the scores of the test set, converting it into a table.
score <- result[2] %>% as.data.table() %T>% print()
```

```{R}
#Select the elements of the first column of the balanced data set, remove the class column, replace the missing values in the elements with 0, and use it as the training set.
train = data_blcd[[1]] %>% mutate(across(-class,.fns = ~tidyr::replace_na(.x,0))) %>% dplyr::slice(sample(nrow(data_blcd[[1]]), 2000), preserve = TRUE) 
#Select test set.
test = data_blcd[[2]]
#Tune the decision tree model by hyperband.
inst_rp <- mi_tune_rp(train, test)
#Train the decision tree model.  
result_rp <- mi_train_rp(train, test, measure = msr("classif.acc"), instance = inst_rp[[1]])
#Tune the random forest model by hyperband.
inst_rg <- mi_tune_rg(train, test)
#Train the random forest model.  
result_rg <- mi_train_rg(train, test, measure = msr("classif.acc"), instance = inst_rg[[1]])
#Tune the xgboost model by hyperband.
inst_xgb <- mi_tune_xgb(train, test)
#Train the xgboost model.
result_xgb <- mi_train_xgb(train, test, measure = msr("classif.acc"), instance = inst_xgb[[1]])
```

```{R}
install.packages("reticulate")
library(reticulate)
#tensorflow需要在python环境下安装，点击readma链接就可以看到安装教程
library(tensorflow)
```

```{R}
#Train the neural network model.
result_BP <- mi_train_BP(train, test, path2save = NULL, batch_size = 128, epochs = 64, validation_split = 0.3)
```

## 5.Models Explaining

```{R}
#Obfuscation matrix about the decision tree is obtained.
matri_rp <- mi_get_confusion(result_rp)
#Obfuscation matrix about random forest is obtained.
matri_rg <- mi_get_confusion(result_rg)
#Obfuscation matrix about xgboost is obtained.
matri_xgb <- mi_get_confusion(result_xgb)
#Obfuscation matrix about the neural network is obtained.
matri_BP <- mi_get_confusion(result_BP,ifnet = T)
#Confusion matrix heat map on decision tree.
mi_plot_heatmap(matri_rp, name="rp",filepath = "Graph/")
#Confusion matrix heat map on random forests.
mi_plot_heatmap(matri_rg, name="rg",filepath = "Graph/")
#Confusion matrix heat map on xgboost.
mi_plot_heatmap(matri_xgb, name="xgb",filepath = "Graph/")
#Confusion matrix heat map on neural network.
mi_plot_heatmap(matri_BP, name="BP",filepath = "Graph/")
```

```{R}
data("mi_data_rawID")
MantaID:::mi_unify_mod(mi_data_rawID, "ID",result_rg,result_rp,result_xgb,result_BP,c_value = 0.75, pad_len = pad_len)
```




